# SLIP-0024 : Trezor payment request format

```
Number:  SLIP-0024
Title:   Trezor payment request format
Type:    Standard
Status:  Draft
Authors: Andrew Kozlik <andrew.kozlik@satoshilabs.com>
Created: 2021-12-09
```

## Abstract

A Trezor payment request is a message that is signed by a trusted party requesting payment of a specified amount to one or more addresses, similar in principle to [BIP-70](https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki).
This message can be processed by a payer's wallet in such a way that the payer does not have to inspect the destination address and only needs to confirm the payment of the requested amount to the recipient that is named in the payment request.

## Motivation

When making a Bitcoin payment the recipient of the payment needs to securely communicate their Bitcoin address to the payer. If the communication channel between the two parties is not well secured or if one of the endpoints is compromised by malware, then an attacker may modify the address, changing it to the attacker's own address in order to receive the payment instead of the legitimate recipient. This type of attack is known as *address spoofing*.

Hardware wallets are known to be the most secure solution to cryptocurrency payments. They are generally very resilient to malware, but they do not protect the payer from address spoofing outside of the wallet. The task of authenticating the address is up to the payer who should ideally verify the correctness of the address by means of a second channel. Using multiple channels to communicate the address reduces the likelihood of an attacker being able to compromise all of them at once, but at the same time it hinders the user experience.

This specification defines a new format of payment requests which aim to make cryptocurrency payments in hardware wallets safer and more user-friendly by allowing automated authentication of merchant's addresses using digital signatures.

### Differences over BIP-70

The Trezor payment request format is heavily inspired by the earlier [BIP-70](https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki) specification. The main ways in which the present specification differs over BIP-70 are summarized below.

* Adapted to the needs of hardware wallets.
  * A nonce challenge is used to guarantee freshness instead of creation/expiry time, since the current time is not reliably available in hardware wallets.
  * The way in which data is hashed is optimized for memory-constrained environments.
  * PKI is considered out of scope of this specification, thus X.509 support is not required.
* Designed for use with multiple cryptocurrencies.
* Defines new types of memo fields, which allow for new use-cases.
* The signature is required.

## Payment request items

### Recipient name

The recipient name is shown to the payer instead of the address or addresses which the payment request represents. The payer must however have the option of inspecting the addresses if they wish.

### Memos

Memos are used to provide additional information to the payer about the purpose of the payment request.
A memo may also contain information that needs to be verified by the payer or their wallet. By making the payment to the specified address the payer confirms that the information in the memo is correct. Two types of memos are defined.

#### Text memo

A text memo is a UTF-8 encoded, plain-text note explaining the purpose of the payment request.
The note must be displayed to the payer in full.

#### Coin purchase memo

A coin purchase memo can be used by a cryptocurrency exchange service to inform their client about the cryptocurrency and amount that the client will receive in exchange for the payment they make. The memo also specifies the address to which the exchange will send the exchanged amount. The client can verify that the address to which the exchange intends to send the funds is correct.

### Nonce

A unique challenge generated by the payer's wallet. The nonce guarantees freshness of the payment request and prevents replaying the payment request to the wallet or to another wallet. A nonce MUST be present whenever one or more memos are present in the payment request.

### Requested outputs

A list of destination addresses with requested amounts. The payer is requested to pay the specified amount to each of the listed addresses.

### Payment request signature

A digital signature of the payment request issued by a party which is trusted by the payer.

A hash of the payment request is signed using the private key of the trusted party.
The default signature scheme is ECDSA with SHA-256 and the curve secp256k1, but any other suitable signature scheme may be used instead.

The hash of the payment request is computed by taking the concatenation of the following fields:

* *versionMagic* (4 bytes): b"\x53\x4c\x00\x24" (this is "SL" followed by 0024 in compressed numeric form as an abbreviation for "SLIP-0024").
* *nonce* (length-prefixed binary string): an optional nonce challenge from the wallet. If a nonce is not used, then a zero-length string should be provided.
* *recipientName* (length-prefixed UTF-8 string): a human-readable string identifying the recipient of the payment.
* *n* (VarInt): the number of memos which follow. The VarInt MUST be encoded in the fewest possible number of bytes.
* *memo*<sub>1</sub> || *memo*<sub>2</sub> || ... || *memo*<sub>*n*</sub> (variable length): concatenation of the binary encoding of the memos.
* *coinType* (4 bytes): 32-bit encoding of the SLIP-0044 coin type of the outputs in little-endian byte order.
* *outputsHash* (32 bytes): the SHA-256 of the binary encodings of all requested outputs.

A text memo is encoded as the concatenation of the following fields:

* *memoType* (4 bytes): b"\x00\x00\x00\x00".
* *text* (length-prefixed UTF-8 string): a human-readable string providing information about the purpose of the payment.

A coin purchase memo is encoded as follows:

* *memoType* (4 bytes): b"\x01\x00\x00\x00" (32-bit encoding of the integer 1 in little-endian byte order).
* *coinType* (4 bytes): 32-bit encoding of the SLIP-0044 coin type that will be delivered in little-endian byte order.
* *amount* (8 bytes): 64-bit encoding of the amount that will be delivered in little-endian byte order.
* *address* (length-prefixed string): the address where the coin purchase will be delivered.

The value of *outputsHash* is computed as the SHA-256 hash of the concatenation of the binary encodings of the requested outputs. The binary encoding of an output is the concatenation of the following fields:

* *amount* (8 bytes): 64-bit encoding of the amount of the requested output in little-endian byte order.
* *address* (length-prefixed string): the address of the requested output.

### Address authentication code

An address authentication code can be used to prove to a wallet that an address was derived from the wallet's seed without needing to specify the derivation path.

Let *k* be a secret *address authentication key* derived from the wallet's master secret using the [SLIP-0021](https://github.com/satoshilabs/slips/blob/master/slip-0021.md) method for hierarchical derivation of symmetric keys as:

```
k = Key(m/"SLIP-0024"/"Address MAC key")
```

The address authentication code is computed as:

```
mac = HMAC-SHA256(key = k, msg = coinType || address)
```
where `coinType || address` is the concatenation of the following fields:

* *coinType* (4 bytes): 32-bit encoding of the SLIP-0044 coin type of the address in little-endian byte order.
* *address* (length-prefixed string): the address being authenticated.

## Test vectors

TODO

## References

* [BIP-0070](https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki): Payment Protocol
